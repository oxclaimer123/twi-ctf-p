<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator Challenge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #101426; color: #fff; }
        .challenge-box { background: #181c2f; border-radius: 1.5rem; padding: 2rem; max-width: 600px; margin: 40px auto; box-shadow: 0 0 24px #0003; }
        textarea { font-family: 'Fira Mono', 'Consolas', monospace; font-size: 1.1em; min-height: 220px; background: #23284a; color: #fff; border-radius: 1rem; border: none; padding: 1rem; }
        .btn-check { background: #ffd700; color: #222; font-weight: bold; }
        .btn-check:hover { background: #ffe066; }

        #sure {
            background-color: rgb(0, 0, 0);
            color: white;
            position: relative;
            top: 1px;
            font-size: 1.3em;
            padding: 14px 0;
            min-width: 80px;
            border: none;
            margin: 2px 0px;
            display: inline-block !important;
        }

        #sure:hover {
            background-color: rgb(61, 61, 61);
            color: white;
            border: 1px solid #000000 !important;
        }
    </style>
</head>
<body>
    <div class="challenge-box">
        <div class="d-flex justify-content-end mb-2">
            <div class="dropdown">
                <button class="btn btn-outline-light dropdown-toggle" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="lang-label">العربية</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="langDropdown">
                    <li><a class="dropdown-item" href="#" id="lang-ar">العربية</a></li>
                    <li><a class="dropdown-item" href="#" id="lang-en">English</a></li>
                </ul>
            </div>
        </div>
        <h3 class="mb-3" id="challenge-title">Calculator Challenge</h3>
        <p id="challenge-desc">قم بإصلاح الخطأ في كود الآلة الحاسبة التالي (بايثون):</p>

        <form id="challenge_form">
            <textarea id="py_code" class="w-100 mb-3" spellcheck="false" style="min-height:340px;resize:vertical;font-size:1.2em;">
def calc(a, b, op):
    if op == '+':
        return a + b
    elif op == '-':
        return a - b
    elif op == '*':
        return a * b
    elif op == '/':
        return a // b  
    else:
        return 'Invalid op'

print(calc(10, 2, '/')) 
</textarea>
            <div id="challenge_msg" class="mt-2"></div>
            <div class="d-flex flex-row gap-2 mt-3 justify-content-center align-items-center">
            <button type="button" id="hint-btn" class="btn btn-secondary btn-lg" style="font-size:1.1em;min-width:120px;">عرض Hint</button>
            <button id="sure" type="submit" class="btn btn-secondary btn-lg" style="font-size:1.1em;min-width:120px;">تأكيد الحل</button>
            </div>
            <div class="d-flex flex-row justify-content-center align-items-center mt-2">
                <span id="hint-box" class="alert alert-warning text-dark mb-0 d-none" style="font-size:1.1em;white-space:normal;max-width:400px;">
                    💡 <b>Hint:</b> استخدم القسمة العادية في بايثون وليس القسمة الصحيحة (//).<br>
                    <span class="badge bg-danger text-light mt-2">سيتم خصم 15 نقطة من مجموع النقاط (75 نقطة بدلاً من 90)</span>
                </span>
            </div>
            <div class="d-flex flex-row justify-content-center align-items-center mt-4">
                <button type="button" id="back-btn" class="btn btn-outline-light btn-lg" style="min-width:140px;font-size:1.1em;">
                    <i class="bi bi-arrow-right-circle"></i> <span id="back-btn-label">العودة للتحديات</span>
                </button>
            </div>
        </form>
    </div>

    <script>
const API = 'https://bb11-37-224-52-18.ngrok-free.app';

// --- اللغة ---
const translations = {
    ar: {
        lang: 'العربية',
        challengeTitle: 'تحدي الآلة الحاسبة',
        challengeDesc: 'قم بإصلاح الخطأ في كود الآلة الحاسبة التالي (بايثون):',
        hintBtn: 'عرض Hint',
        sureBtn: 'تأكيد الحل',
        hintBox: '💡 <b>Hint:</b> استخدم القسمة العادية في بايثون وليس القسمة الصحيحة (//).<br><span class="badge bg-danger text-light mt-2">سيتم خصم 15 نقطة من مجموع النقاط (75 نقطة بدلاً من 90)</span>',
        backBtn: 'العودة للتحديات',
        alreadySolved: 'تم حل التحدي مسبقًا، لا يمكنك إعادة الحل أو الحصول على نقاط إضافية.',
        success: points => `أحسنت! تم حل التحدي وإضافة ${points} نقطة إلى حسابك.`,
        loginFirst: 'يجب تسجيل الدخول أولاً',
        errorAdd: 'حدث خطأ في إضافة النقاط',
        serverError: 'تعذر الاتصال بالسيرفر',
        wrong: 'الحل غير صحيح. حاول مرة أخرى!',
    },
    en: {
        lang: 'English',
        challengeTitle: 'Calculator Challenge',
        challengeDesc: 'Fix the bug in the following calculator code (Python):',
        hintBtn: 'Show Hint',
        sureBtn: 'Submit Solution',
        hintBox: '💡 <b>Hint:</b> Use normal division in Python, not integer division (//).<br><span class="badge bg-danger text-light mt-2">15 points will be deducted (75 points instead of 90)</span>',
        backBtn: 'Back to Challenges',
        alreadySolved: 'You have already solved this challenge. You cannot solve it again or get extra points.',
        success: points => `Great! Challenge solved and ${points} points added to your account.`,
        loginFirst: 'You must log in first',
        errorAdd: 'Error adding points',
        serverError: 'Could not connect to server',
        wrong: 'Incorrect solution. Try again!',
    }
};

function setLang(lang) {
    localStorage.setItem('lang', lang);
    document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
    document.getElementById('lang-label').textContent = translations[lang].lang;
    document.getElementById('challenge-title').textContent = translations[lang].challengeTitle;
    document.getElementById('challenge-desc').textContent = translations[lang].challengeDesc;
    document.getElementById('hint-btn').textContent = translations[lang].hintBtn;
    document.getElementById('sure').textContent = translations[lang].sureBtn;
    document.getElementById('hint-box').innerHTML = translations[lang].hintBox;
    document.getElementById('back-btn-label').textContent = translations[lang].backBtn;
}

// عند تحميل الصفحة
let lang = localStorage.getItem('lang') || 'ar';
setLang(lang);
document.getElementById('lang-ar').onclick = function(e) {
    e.preventDefault();
    setLang('ar');
};
document.getElementById('lang-en').onclick = function(e) {
    e.preventDefault();
    setLang('en');
};

const correct = /return\s+a\s*\/\s*b/;
let usedHint = false;

// تحقق إذا كان التحدي محلول مسبقاً
let alreadySolved = false;
const username = localStorage.getItem('username');
async function checkSolved() {
    if (!username) return;
    try {
        const res = await fetch(API + '/userchallenges', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
        });
        const data = await res.json();
        if (data.calculator) {
            alreadySolved = true;
            document.getElementById('sure').disabled = true;
            document.getElementById('challenge_msg').innerHTML =
                `<div class="alert alert-success">${translations[lang].alreadySolved}</div>`;
        }
    } catch (err) {
        // تجاهل الخطأ
    }
}
checkSolved();

document.getElementById('hint-btn').onclick = function() {
    const hintBox = document.getElementById('hint-box');
    hintBox.classList.remove('d-none');
    hintBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
    usedHint = true;
};

document.getElementById('challenge_form').onsubmit = async function(e) {
    e.preventDefault();
    const msg = document.getElementById('challenge_msg');
    const code = document.getElementById('py_code').value;
    const challengeBox = document.querySelector('.challenge-box');
    if (alreadySolved) {
        msg.innerHTML = `<div class="alert alert-success">${translations[lang].alreadySolved}</div>`;
        if (challengeBox) {
            challengeBox.innerHTML = `<div class="alert alert-success text-center" style="font-size:1.5em;padding:3em 0;">This Challenge solved !!</div>`;
        }
        return;
    }
    msg.innerHTML = `<div class="alert alert-info">${lang === 'ar' ? 'جاري التحقق من الحل...' : 'Checking solution...'}</div>`;
    if (correct.test(code)) {
        if (!username) {
            msg.innerHTML = `<div class="alert alert-danger">${translations[lang].loginFirst}</div>`;
            return;
        }
        const points = usedHint ? 75 : 90;
        try {
            const res = await fetch(API + '/addpoints', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, points, challenge: 'calculator' })
            });
            const data = await res.json();
            if (res.ok && data && data.solved) {
                msg.innerHTML = `<div class="alert alert-success">${translations[lang].success(points)}</div>`;
                alreadySolved = true;
                document.getElementById('sure').disabled = true;
                if (challengeBox) {
                    challengeBox.innerHTML = `<div class="alert alert-success text-center" style="font-size:1.5em;padding:3em 0;">This Challenge solved !!</div>`;
                }
            } else if (res.ok && data && data.alreadySolved) {
                msg.innerHTML = `<div class="alert alert-success">${translations[lang].alreadySolved}</div>`;
                alreadySolved = true;
                document.getElementById('sure').disabled = true;
                if (challengeBox) {
                    challengeBox.innerHTML = `<div class="alert alert-success text-center" style="font-size:1.5em;padding:3em 0;">This Challenge solved !!</div>`;
                }
            } else {
                msg.innerHTML = `<div class='alert alert-danger'>${data.message || translations[lang].errorAdd}</div>`;
            }
        } catch (err) {
            msg.innerHTML = `<div class="alert alert-danger">${translations[lang].serverError}</div>`;
        }
    } else {
        msg.innerHTML = `<div class="alert alert-warning">${translations[lang].wrong}</div>`;
    }
};

// زر العودة للتحديات
document.getElementById('back-btn').onclick = function() {
    window.location.href = '/home';
};
</script>
</body>
</html>